Session 9 HTTP and FTP
==============================


Apache Web Server
----------------------------------------------------

Service name: httpd

Package name: httpd-{ver}.{arch}.rpm

Main config: /etc/httpd/conf/httpd.conf

Module config: /etc/httpd/conf.d

Default DocRoot: /var/www/html

Installation and Basic Configuration
--------------------------------------

#. Install the ``web-server`` package group:

	::
	
		# yum groupinstall web-server

	.. 
	
	Note that this install several packages including the Apache Manual which is then locally accessible at http://localhost/manual

#. Install the ``mod_ssl`` package::

		# yum install mod_ssl

#. Start and configure persistence::

		# service httpd start; chkconfig httpd on

In this default configuration, you can create an ``index.html`` page in ``/var/www/html/`` and it will be served out as your home page.

Installing a Signed SSL Certificate
---------------------------------------

#. Place the certificate and private key in the appropriate locations in ``/etc/pki/tls/``

#. Ensure that both files have the ``cert_t`` SELinux file context and that the private key is readable only by root.

#. Modify ``/etc/httpd/conf.d/ssl.conf``:

	* ``SSLCertificateFile`` points to your newly installed certificate.
	* ``SSLCertificateKeyFile`` points to the corresponding private key.

#. Restart the service



Virtual Host Configuration
----------------------------------------------------

Near the end of httpd.conf, uncomment the line::

#NameVirtualHost *:80

Create a section for each vhost:

Apache Access Control
----------------------------------------------------

Per-directory options









Firewall and SELinux for httpd
----------------------------------------------------



.. o HTTP(s)
.. + * Install the packages needed to provide the service
.. + * Configure SELinux to support the service
.. + * Configure the service to start when the system is booted
.. + * Configure the service for basic operation
.. + * Configure host-based and user-based security for the service
.. + * Configure a virtual host
.. + * Configure private directories
.. + * Deploy a basic CGI application
.. + * Configure group-managed content


Very Secure File Transfer Protocol Daemon
-------------------------------------------------

``vsftpd`` is Red Hat's preferred FTP daemon.  The "Very Secure" descriptor refers to the daemon and not to the protocol!

The only mention of FTP in the RHCSA objectives is concerned with enabling a default configuration

The only mention of FTP in the RHCE objectives is concerned with securely configuring anonymous access.


Installation and Basic Configuration
------------------------------------------

Package: vsftpd

Install::

    # yum -y install vsftpd

Start and Configure Persistence::

    # service vsftpd start; chkconfig vsftpd on

In this default configuration, anonymous downloads are allowed from ``/pub`` (as shown to the client) and are placed in ``/var/ftp/pub/`` (as viewed on the server). Additionally, system users are able to login by username and password and access their home directories with read/write permissions. No anonymous uploads are permitted by default.

FTP Documentation
-------------------------

Man Pages:

    * vsftpd.conf (5)
    * ftpd_selinux (8)
    
Investigate SELinux implications for FTP
-------------------------------------------


Find SELinux Filesystem contexts that might affect FTP::

    # semanage fcontext -l | grep "ftp"

Find SELinux port contexts that might affect FTP::

    # semanage port -l | grep "ftp"
    
Find SELinux booleans that might affect FTP::

    # semanage boolean -l | grep ftp



Investigate Firewall Implications for FTP
----------------------------------------------

Find ports that may need to be opened for FTP::

    # grep ftp /etc/services 

    
Configuring a Secure "Drop-box" for Anon Upload
-------------------------------------------------

#. Create an upload directory owned by ``root.ftp`` and with 730 permissions::

    cd /var/ftp
    mkdir incoming 
    chgrp ftp incoming
    chmod 730 incoming


#. Modify SELinux

	* Set context of ``public_content_rw_t`` on the upload directory::

		semanage fcontext -a -t public_content_rw_t '/var/ftp/incoming(/.*)?'
		restorecon -rvv /var/ftp/


	* Enable the ``allow_ftp_anon_write`` boolean::

		setsebool -P allow_ftpd_anon_write on


#. Modify ``/etc/vsftpd/vsftpd.conf`` as follows::

    anonymous_enable=YES
    local_enable=NO
    write_enable=YES
    anon_upload_enable=YES
    chown_uploads=YES
    chown_username=daemon
    anon_umask = 077

#. Modify iptables for inbound ftp

	* in ``/etc/sysconfig/iptables-config``::

		    IPTABLES_MODULES="nf_conntrack_ftp nf_nat_ftp"

	* Set rules::

		# iptables -A INPUT -p tcp --dport 21 -j ALLOW
		# iptables -A INPUT -m state --state ESTABLISHED,RELATED -j ALLOW


.. o FTP
.. + * Install the packages needed to provide the service
.. + * Configure SELinux to support the service
.. + * Configure the service to start when the system is booted
.. + * Configure the service for basic operation
.. + * Configure host-based and user-based security for the service
.. + * Configure anonymous-only download


